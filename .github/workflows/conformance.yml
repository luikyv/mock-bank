name: Conformance Suite Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    env:
      CS_VERSION: "6111a8e835350b9270a7443a42329628e62f368f"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache Conformance Suite Repository
        uses: actions/cache@v3
        id: cache-cs
        with:
          path: ./conformance-suite
          key: cs-${{ env.CS_VERSION }}

      - name: Set Up Conformance Suite
        if: steps.cache-cs.outputs.cache-hit != 'true'
        run: |
          make setup-cs

      # Only needed if you also want to curl from the host by name.
      - name: Add Host Entries
        run: |
          echo "127.0.0.1 auth.mockbank.local" | sudo tee -a /etc/hosts

      - name: Start containers and wait
        run: |
          set -euxo pipefail

          # Dump logs if any command in this step fails
          dump_logs() {
            echo "===== DOCKER COMPOSE SERVICES ====="
            docker compose config --services || true
            echo "===== DOCKER COMPOSE PS ====="
            docker compose ps || true
            echo "===== RECENT LOGS (mtls, auth, mockapi, cs-runner if present) ====="
            docker compose logs --no-color --tail=200 mtls auth mockapi cs-runner || true
          }
          trap 'echo "[TRAP] Failure detected. Collecting diagnostics..."; dump_logs' ERR

          echo "== Docker/Compose versions =="
          docker version
          docker compose version

          echo "== Bringing up stack =="
          docker compose --profile conformance up -d

          echo "== Services (with current profiles) =="
          docker compose config --services

          echo "== Containers =="
          docker compose ps

          # ---------- helper: wait for an HTTPS endpoint from the host ----------
          wait_http() {
            url="$1"; timeout_s="${2:-120}"
            start=$(date +%s)
            while :; do
              code=$(curl -sk -o /dev/null -w '%{http_code}' "$url" || echo 000)
              if [ "$code" = "200" ]; then
                echo "OK: $url"
                return 0
              fi
              if [ $(( $(date +%s) - start )) -ge "$timeout_s" ]; then
                echo "TIMEOUT ($timeout_s s) for $url (last code: $code)"
                return 1
              fi
              echo "Waiting for $url (last code: $code). Sleeping 2s"
              sleep 2
            done
          }

          echo "== Wait for Conformance Suite on host (https://localhost:8443) =="
          wait_http "https://localhost:8443/api/runner/available" 120

          echo "== (Optional) Show mock bank OIDC doc from host =="
          curl -sk -i https://auth.mockbank.local/.well-known/openid-configuration -w "\nHTTP %{http_code}\n" || true

          # ---------- determine compose network name ----------
          # Grab any container from this compose project, read its network id, then resolve the network name
          compose_net="$(docker compose ps -q | head -n1 | xargs -r docker inspect -f '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}' | xargs -r docker network inspect -f '{{.Name}}' || true)"
          if [ -z "${compose_net:-}" ]; then
            echo "Could not determine compose network; dumping ps for context:"
            docker compose ps
            echo "Failing early since inside-network wait depends on the network."
            exit 1
          fi
          echo "== Compose network: $compose_net =="

          # ---------- wait for mock bank from inside the docker network ----------
          # We connect to mtls:443 while preserving SNI/Host as auth.mockbank.local using --connect-to.
          # This bypasses the need for 'auth.mockbank.local' to resolve inside the container.
          echo "== Wait for Mock Bank inside the compose network (via mtls) =="
          start=$(date +%s)
          while :; do
            code=$(docker run --rm --network "$compose_net" curlimages/curl:8.10.1 \
              -sk --connect-to auth.mockbank.local:443:mtls:443 \
              -o /dev/null -w '%{http_code}' \
              https://auth.mockbank.local/.well-known/openid-configuration || echo 000)
            if [ "$code" = "200" ]; then
              echo "Mock bank is ready (inside network)"
              break
            fi
            if [ $(( $(date +%s) - start )) -ge 300 ]; then
              echo "TIMEOUT (300s) waiting for mock bank (last code: $code)"
              exit 1
            fi
            echo "Mock bank not ready yet (last code: $code). Sleeping 2s"
            sleep 2
          done

      - name: Run Tests
        run: |
          set -euxo pipefail
          make cs-tests

      - name: Upload Test Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mockbank
          path: conformance-suite/results/*.zip

  all-tests-succeeded:
    runs-on: ubuntu-latest
    needs: run-tests
    if: success()
    steps:
      - name: Test plans passed
        run: echo "All test plans passed successfully!"
